<!doctype html>
<html>
  <head>
    <title>Server Test Client</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #1a1a1a;
        color: #fff;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        background: #333;
      }
      .connected {
        background: #2d5016;
      }
      .disconnected {
        background: #501616;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        font-size: 16px;
        cursor: pointer;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
      }
      button:hover {
        background: #45a049;
      }
      input {
        padding: 10px;
        margin: 5px;
        font-size: 16px;
        border-radius: 5px;
        border: 1px solid #555;
        background: #333;
        color: white;
      }
      #log {
        background: #000;
        padding: 15px;
        margin-top: 20px;
        border-radius: 5px;
        height: 400px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 14px;
      }
      .log-entry {
        margin: 5px 0;
        padding: 5px;
      }
      .log-info {
        color: #5bc0de;
      }
      .log-success {
        color: #5cb85c;
      }
      .log-error {
        color: #d9534f;
      }
    </style>
  </head>
  <body>
    <h1>üéÆ Multiplayer Server Test</h1>

    <div id="status" class="status disconnected">‚ùå Not connected</div>

    <div>
      <input
        type="text"
        id="username"
        placeholder="Enter username"
        value="TestPlayer"
      />
      <select id="character">
        <option value="Independent Detective">Detective L</option>
        <option value="Vigilante">Kira</option>
      </select>
    </div>

    <div>
      <button onclick="connect()">Connect to Server</button>
      <button onclick="findMatch()">Find Match</button>
      <button onclick="pingServer()">Ping Server</button>
      <button onclick="selectCard()">Select Card (Test)</button>
      <button onclick="clearLog()">Clear Log</button>
    </div>

    <div id="log"></div>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
      let socket = null;
      let currentRoomId = null;
      let currentHand = []; // Track current hand

      function log(message, type = "info") {
        const logDiv = document.getElementById("log");
        const entry = document.createElement("div");
        entry.className = `log-entry log-${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function updateStatus(connected) {
        const statusDiv = document.getElementById("status");
        if (connected) {
          statusDiv.className = "status connected";
          statusDiv.textContent = "‚úÖ Connected to server";
        } else {
          statusDiv.className = "status disconnected";
          statusDiv.textContent = "‚ùå Not connected";
        }
      }

      function connect() {
        if (socket && socket.connected) {
          log("Already connected!", "error");
          return;
        }

        log("Connecting to server...", "info");
        socket = io("http://localhost:3001");

        socket.on("connect", () => {
          log(`Connected! Socket ID: ${socket.id}`, "success");
          updateStatus(true);
        });

        socket.on("disconnect", () => {
          log("Disconnected from server", "error");
          updateStatus(false);
          socket = null;
        });

        socket.on("pong", (data) => {
          log(`Pong received: ${data.message}`, "success");
        });

        socket.on("matchFound", (data) => {
          currentRoomId = data.roomId; // Store room ID
          log(`üéâ MATCH FOUND!`, "success");
          log(`Room ID: ${data.roomId}`, "info");
          log(`You are Player ${data.playerNumber}`, "info");
          log(
            `Opponent: ${data.opponent.username} (${data.opponent.character})`,
            "info",
          );

          // Display initial game state
          if (data.gameState) {
            currentHand = data.gameState.yourHand; // Store hand
            log(`--- INITIAL GAME STATE ---`, "success");
            log(
              `üñêÔ∏è  Your hand (${data.gameState.yourHand.length} cards):`,
              "info",
            );
            data.gameState.yourHand.forEach((card, i) => {
              log(
                `   ${i + 1}. ${card.name} (${card.cardType}, ${card.energyCost} energy) - ID: ${card.id}`,
                "info",
              );
            });
            log(`‚ö° Your energy: ${data.gameState.yourEnergy}`, "info");
            log(`üÉè Your deck: ${data.gameState.yourDeckSize} cards`, "info");
            log(
              `üìä Your stats: Inv:${data.gameState.yourStats.investigation} Morale:${data.gameState.yourStats.morale} Opinion:${data.gameState.yourStats.publicOpinion} Pressure:${data.gameState.yourStats.pressure}`,
              "info",
            );
            log(
              `üéØ Opponent deck: ${data.gameState.opponentDeckSize} cards, hand: ${data.gameState.opponentHandSize} cards`,
              "info",
            );
          }
        });

        socket.on("cardAccepted", (data) => {
          log(`‚úÖ Card accepted: ${data.cardId}`, "success");
        });

        socket.on("opponentCardSelected", () => {
          log(`‚è≥ Opponent selected a card (waiting...)`, "info");
        });

        socket.on("turnComplete", (data) => {
          log(`\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`, "success");
          log(`üé¥ TURN ${data.gameState.turn - 1} COMPLETE!`, "success");
          log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`, "success");
          log(
            `Your card: ${data.yourCard.name} (${data.yourCard.cardType})`,
            "info",
          );
          log(
            `Opponent card: ${data.opponentCard.name} (${data.opponentCard.cardType})`,
            "info",
          );

          log(`\nüìä UPDATED STATS:`, "success");
          log(
            `Your stats: Inv:${data.gameState.yourStats.investigation} Morale:${data.gameState.yourStats.morale} Opinion:${data.gameState.yourStats.publicOpinion} Pressure:${data.gameState.yourStats.pressure}`,
            "info",
          );
          log(
            `Opponent stats: Inv:${data.gameState.opponentStats.investigation} Morale:${data.gameState.opponentStats.morale} Opinion:${data.gameState.opponentStats.publicOpinion} Pressure:${data.gameState.opponentStats.pressure}`,
            "info",
          );

          log(`\n‚ö° ENERGY:`, "success");
          log(`Your energy: ${data.gameState.yourEnergy}`, "info");
          log(`Opponent energy: ${data.gameState.opponentEnergy}`, "info");

          currentHand = data.gameState.yourHand; // Update hand
          log(
            `\nüñêÔ∏è YOUR NEW HAND (${data.gameState.yourHand.length} cards):`,
            "success",
          );
          data.gameState.yourHand.forEach((card, i) => {
            log(
              `   ${i + 1}. ${card.name} (${card.cardType}, ${card.energyCost} energy) - ID: ${card.id}`,
              "info",
            );
          });

          log(`\nüÉè DECKS:`, "success");
          log(
            `Your deck: ${data.gameState.yourDeckSize} cards remaining`,
            "info",
          );
          log(
            `Opponent deck: ${data.gameState.opponentDeckSize} cards, hand: ${data.gameState.opponentHandSize} cards`,
            "info",
          );
          log(`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`, "success");
        });

        socket.on("gameOver", (data) => {
          log(
            `\nüèÜüèÜüèÜ GAME OVER! üèÜüèÜüèÜ`,
            data.winner === "you" ? "success" : "error",
          );
          log(
            `Result: ${data.winner === "you" ? "YOU WIN!" : "YOU LOSE!"}`,
            data.winner === "you" ? "success" : "error",
          );
          log(`Reason: ${data.reason}`, "info");
          log(`\nFinal Stats:`, "info");
          log(
            `Your stats: Inv:${data.finalStats.yourStats.investigation} Morale:${data.finalStats.yourStats.morale} Opinion:${data.finalStats.yourStats.publicOpinion} Pressure:${data.finalStats.yourStats.pressure}`,
            "info",
          );
          log(
            `Opponent stats: Inv:${data.finalStats.opponentStats.investigation} Morale:${data.finalStats.opponentStats.morale} Opinion:${data.finalStats.opponentStats.publicOpinion} Pressure:${data.finalStats.opponentStats.pressure}`,
            "info",
          );
        });

        socket.on("bothCardsSelected", (data) => {
          // This event is now replaced by turnComplete, but keep for backwards compatibility
          log(`üé¥ BOTH CARDS SELECTED!`, "success");
          log(`Your card: ${data.yourCard}`, "info");
          log(`Opponent card: ${data.opponentCard}`, "info");
        });

        socket.on("error", (data) => {
          log(`‚ùå Error: ${data.message}`, "error");
        });

        socket.on("opponentDisconnected", () => {
          log("‚ö†Ô∏è Opponent disconnected!", "error");
          currentRoomId = null;
        });
      }

      function pingServer() {
        if (!socket || !socket.connected) {
          log('Not connected! Click "Connect to Server" first', "error");
          return;
        }

        log("Sending ping...", "info");
        socket.emit("ping");
      }

      function selectCard() {
        if (!socket || !socket.connected) {
          log('Not connected! Click "Connect to Server" first', "error");
          return;
        }

        if (!currentRoomId) {
          log("Not in a match! Find a match first", "error");
          return;
        }

        if (!currentHand || currentHand.length === 0) {
          log("No cards in hand! Find a match first.", "error");
          return;
        }

        // Select a random card from the actual hand
        const randomCard =
          currentHand[Math.floor(Math.random() * currentHand.length)];

        if (!randomCard || !randomCard.id) {
          log("Error: Invalid card selected!", "error");
          return;
        }

        log(
          `Selecting card: ${randomCard.name} (ID: ${randomCard.id})`,
          "info",
        );
        socket.emit("selectCard", {
          roomId: currentRoomId,
          cardId: randomCard.id,
        });
      }

      function findMatch() {
        if (!socket || !socket.connected) {
          log('Not connected! Click "Connect to Server" first', "error");
          return;
        }

        const username = document.getElementById("username").value;
        const character = document.getElementById("character").value;

        log(`Looking for match as ${username} (${character})...`, "info");
        socket.emit("findMatch", { username, character });
      }

      function clearLog() {
        document.getElementById("log").innerHTML = "";
      }

      // Make functions globally accessible for onclick handlers
      window.connect = connect;
      window.findMatch = findMatch;
      window.pingServer = pingServer;
      window.selectCard = selectCard;
      window.clearLog = clearLog;

      // Auto-connect on load
      window.onload = () => {
        log('Test client loaded. Click "Connect to Server" to begin.', "info");
      };
    </script>
  </body>
</html>
